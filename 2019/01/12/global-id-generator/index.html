<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta name="baidu-site-verification" content="WJEAqh4Drc"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="jverson's blog | java | web | Jverson"><title>基于 MySQL 的分布式 ID 生成服务 | 墨言</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.1"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">基于 MySQL 的分布式 ID 生成服务</h1><a id="logo" href="/.">墨言</a><p class="description">LIFE IS SIMPLE, LOVE SMILE AND CODE</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="http://album.jverson.com/"><i class="fa fa-picture-o"> 相册</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">基于 MySQL 的分布式 ID 生成服务</h1><div class="post-meta">Jan 12, 2019<span> | </span><span class="category"><a href="/categories/Coding/">Coding</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2019/01/12/global-id-generator/" href="/2019/01/12/global-id-generator/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>分布式 ID 生成服务在业务系统开发中经常会用到，不过一般都会作为基础服务存在，大多数情况下不需要自己去造一个轮子出来。目前也有很多开源的方案，不过一定要根据业务的实际情况选型，需要满足业务需求的情况下尽可能不要引入额外的复杂性。这里简介绍一下我们在实际项目中采用的基于 MySQL 的 ID 生成方案。</p>
<a id="more"></a>
<p>由于全局 ID 一般业务系统是用来作为数据库的主键进行存储的，因此不能有重复；我们知道数据库（InnoDB）会为主键 建立聚簇索引，也就是说数据库的物理存储会和 ID 的顺序保持一致，为了更方便的支持一些分页或者排序的业务需求，最好 ID 能够是趋势递增的。因此我们对于分布式 ID 生成服务主要会有以下两个要求：</p>
<ul>
<li>全局唯一</li>
<li>趋势有序</li>
</ul>
<p><a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ%3D%3D&amp;mid=2651960245&amp;idx=1&amp;sn=5cef3d8ca6a3e6e94f61e0edaf985d11&amp;chksm=bd2d06698a5a8f7fc89056af619b9b7e79b158bceb91bdeb776475bc686721e36fb925904a67&amp;mpshare=1&amp;scene=1&amp;srcid=0626i5Oy0egfPAKrFc5VFrAK" target="_blank" rel="noopener">分布式 ID 生成器</a> 这篇文章对常见的实现方案做了一下总结。无外乎以下几种：</p>
<ol>
<li><strong> 使用数据库的 auto_increment 来生成全局唯一递增 ID</strong>。实现简单，但扩展性差，写入单点，性能有上限，并且可用性无法保证。</li>
<li><strong> 单点批量 ID 生成服务 </strong>。数据库使用双主保证可用性，数据库中只存储当前 ID 的最大值，每次批量获取 ID 放在缓存中，用完了再取不用每次都访问 DB，这样既可以保证 ID 绝对有序，也大大降低了数据库的压力。但也要意识到此方案依然强依赖 DB、生成的 ID 虽然绝对递增但是可能不连续。</li>
<li><strong>uuid/guid</strong>。不依赖远程服务完全本地化，基本没有性能上限。但缺点明显，无法做到趋势递增、字符串做主键效率低。</li>
<li><strong> 取当前毫秒数 </strong>。这种方法既能保证递增，又是本地服务，看上去好像简单而实用。确实一些简单的场景可以用，但它致命缺点是无法保证唯一性，因为它依赖机器时钟，并且理论并发量不能超过 1000.</li>
<li><strong>类 snowflake 算法</strong>。一种 Twitter 开源的分布式 ID 生成算法，其核心思想其实就是结合毫秒数、机器编号、随机序列号等方式尽可能的避免 ID 重复，又能保证趋势递增。目前很多开源的方案都是基于这一思想的实现。</li>
</ol>
<p>附一些开源实现，在以后的业务使用中建议参考一下这些开源代码，毕竟公司有的组件和代码已经很老了，慢慢的肯定有些不合理和可以优化的地方，不能闭着眼睛直接就拿来用：</p>
<ul>
<li><a href="https://tech.meituan.com/2019/03/07/open-source-project-leaf.html" target="_blank" rel="noopener">Leaf：美团分布式 ID 生成服务开源</a><ul>
<li>提供两种实现方案可供选择：号段模式 &amp; snowflake 模式，<a href="https://github.com/Meituan-Dianping/Leaf" target="_blank" rel="noopener">github 地址</a></li>
</ul>
</li>
<li><a href="https://github.com/baidu/uid-generator/blob/master/README.zh_cn.md" target="_blank" rel="noopener">百度 UidGenerator</a><ul>
<li>基于 Snowflake 算法的唯一 ID 生成器</li>
</ul>
</li>
</ul>
<p>上面介绍了这么多方法，其实抛开业务场景没有绝对好坏，因此使用的时候需要结合实际场景进行选择。我们在做评价系统组件化的时候 MySQL 做了分库分表，线上使用的便是其中第 2 种方案，美团开源的 Leaf 也支持这种方案（号段模式），有空可以学习一下其中的实现做一下对比。下面简单介绍一下我们使用的一些实现细节。</p>
<p>首先创建表结构如下：</p>
<p><img src="https://images.zenhubusercontent.com/5b83aeb622e474383b984d11/9c415b81-45d8-49f7-9c91-99e5729d51bc" alt="image.png"></p>
<p>通过 DataSource（可使用连接池如 druid）配置一个 SequenceUtil</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(name =<span class="string">"sequenceUtil"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> SequenceUtil <span class="title">sequenceUtil</span><span class="params">(@Qualifier(<span class="string">"sequenceUtilDataSource"</span>)</span> DataSource sequenceUtilDataSource)</span>&#123;SequenceUtil  sequenceUtil1 = <span class="keyword">new</span> SequenceUtil();</span><br><span class="line">		Sequence defaultSequenct = <span class="keyword">new</span> Sequence();</span><br><span class="line">		defaultSequenct.setDataSource(sequenceUtilDataSource);</span><br><span class="line">		defaultSequenct.setBlockSize(<span class="number">30</span>);</span><br><span class="line">		defaultSequenct.setStartValue(<span class="number">20000000</span>);</span><br><span class="line">		sequenceUtil1.setDefaultSequence(defaultSequenct);</span><br><span class="line">		<span class="keyword">return</span> sequenceUtil1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用时</span></span><br><span class="line"><span class="keyword">long</span> id= sequenceUtil.get(SequenceKeyEnum.COMMENT.getKey());</span><br></pre></td></tr></table></figure>
<p>来看看 SequenceUtil 的具体实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SequenceUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Sequence defaultSequence;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultSequence</span><span class="params">(Sequence defaultSequence)</span> </span>&#123;<span class="keyword">this</span>.defaultSequence = defaultSequence;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">get</span><span class="params">(String name)</span> </span>&#123;<span class="keyword">if</span> (defaultSequence != <span class="keyword">null</span>) &#123;<span class="keyword">return</span> defaultSequence.get(name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"sequence "</span>+ name +<span class="string">" undefined!"</span>);&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来看看 Sequence 类里的 get 方法具体实现（代码比较老，有很多可以优化的地方）。大概原理就是每次从库里取 blockSize 个 id 出来，缓存一个 stepMap 中，每次业务调用 get 取 id 时先看 stepMap 缓存中还有没有，有则 incrementAndGet，没有再去库里取一批出来。</p>
<p>注意 key 可能不连续，如果取了 5 个出来缓存到 map，只用了其中 2 个，此时应用重启 map 缓存丢失，会去重新从库里去，但是可以保证递增</p>
<p>另外注意 get 方法一定要 synchronized ，避免并发导致 id 重复，明显这种方案吞吐量不高，在单个业务中使用没问题，但是要作为公共服务提供出供多个业务方使用可能就有性能瓶颈了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sequence</span> </span>&#123;<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Log log = LogFactory.getLog(Sequence.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> blockSize = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> startValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String GET_SQL = <span class="string">"select id from sequence_value where name = ?"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String NEW_SQL = <span class="string">"insert into sequence_value (id,name) values (?,?)"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String UPDATE_SQL = <span class="string">"update sequence_value set id = ?  where name = ? and id = ?"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Step&gt; stepMap = <span class="keyword">new</span> HashMap&lt;String, Step&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">getNextBlock</span><span class="params">(String sequenceName, Step step)</span> </span>&#123;Long value = getPersistenceValue(sequenceName);</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;<span class="keyword">try</span> &#123;value = newPersistenceValue(sequenceName); </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;log.error(<span class="string">"newPersistenceValue error!"</span>);</span><br><span class="line">                value = getPersistenceValue(sequenceName); </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> b = saveValue(value,sequenceName) == <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (b) &#123;step.setCurrentValue(value);</span><br><span class="line">            step.setEndValue(value+blockSize);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">get</span><span class="params">(String sequenceName)</span> </span>&#123;Step step = stepMap.get(sequenceName);</span><br><span class="line">        <span class="keyword">if</span>(step ==<span class="keyword">null</span>) &#123;step = <span class="keyword">new</span> Step(startValue,startValue+blockSize);</span><br><span class="line">            stepMap.put(sequenceName, step);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="keyword">if</span> (step.currentValue &lt; step.endValue) &#123;<span class="keyword">return</span> step.incrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; blockSize; i++) &#123;<span class="keyword">if</span> (getNextBlock(sequenceName,step)) &#123;<span class="keyword">return</span> step.incrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No more value."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">saveValue</span><span class="params">(<span class="keyword">long</span> value, String sequenceName)</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement statement = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;connection = dataSource.getConnection();</span><br><span class="line">            statement = connection.prepareStatement(UPDATE_SQL);</span><br><span class="line">            statement.setLong(<span class="number">1</span>, value + blockSize);</span><br><span class="line">            statement.setString(<span class="number">2</span>, sequenceName);</span><br><span class="line">            statement.setLong(<span class="number">3</span>, value);</span><br><span class="line">            <span class="keyword">return</span> statement.executeUpdate();&#125; <span class="keyword">catch</span> (Exception e) &#123;log.error(<span class="string">"newPersistenceValue error!"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"newPersistenceValue error!"</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;<span class="keyword">if</span> (statement != <span class="keyword">null</span>) &#123;<span class="keyword">try</span> &#123;statement.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;log.error(<span class="string">"close statement error!"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;<span class="keyword">try</span> &#123;connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;log.error(<span class="string">"close connection error!"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Long <span class="title">getPersistenceValue</span><span class="params">(String sequenceName)</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement statement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;connection = dataSource.getConnection();</span><br><span class="line">            statement = connection.prepareStatement(GET_SQL);</span><br><span class="line">            statement.setString(<span class="number">1</span>, sequenceName);</span><br><span class="line">            resultSet = statement.executeQuery();</span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;<span class="keyword">return</span> resultSet.getLong(<span class="string">"id"</span>);&#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;log.error(<span class="string">"getPersistenceValue error!"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"getPersistenceValue error!"</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;<span class="keyword">if</span> (resultSet != <span class="keyword">null</span>) &#123;<span class="keyword">try</span> &#123;resultSet.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;log.error(<span class="string">"close resultset error!"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (statement != <span class="keyword">null</span>) &#123;<span class="keyword">try</span> &#123;statement.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;log.error(<span class="string">"close statement error!"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;<span class="keyword">try</span> &#123;connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;log.error(<span class="string">"close connection error!"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Long <span class="title">newPersistenceValue</span><span class="params">(String sequenceName)</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement statement = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;connection = dataSource.getConnection();</span><br><span class="line">            statement = connection.prepareStatement(NEW_SQL);</span><br><span class="line">            statement.setLong(<span class="number">1</span>, startValue);</span><br><span class="line">            statement.setString(<span class="number">2</span>, sequenceName);</span><br><span class="line">            statement.executeUpdate();&#125; <span class="keyword">catch</span> (Exception e) &#123;log.error(<span class="string">"newPersistenceValue error!"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"newPersistenceValue error!"</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;<span class="keyword">if</span> (statement != <span class="keyword">null</span>) &#123;<span class="keyword">try</span> &#123;statement.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;log.error(<span class="string">"close statement error!"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;<span class="keyword">try</span> &#123;connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;log.error(<span class="string">"close connection error!"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> startValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;<span class="keyword">this</span>.dataSource = dataSource;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBlockSize</span><span class="params">(<span class="keyword">int</span> blockSize)</span> </span>&#123;<span class="keyword">this</span>.blockSize = blockSize;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStartValue</span><span class="params">(<span class="keyword">long</span> startValue)</span> </span>&#123;<span class="keyword">this</span>.startValue = startValue;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Step</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">long</span> currentValue;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">long</span> endValue;</span><br><span class="line"></span><br><span class="line">        Step(<span class="keyword">long</span> currentValue, <span class="keyword">long</span> endValue) &#123;</span><br><span class="line">            <span class="keyword">this</span>.currentValue = currentValue;</span><br><span class="line">            <span class="keyword">this</span>.endValue = endValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCurrentValue</span><span class="params">(<span class="keyword">long</span> currentValue)</span> </span>&#123;<span class="keyword">this</span>.currentValue = currentValue;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEndValue</span><span class="params">(<span class="keyword">long</span> endValue)</span> </span>&#123;<span class="keyword">this</span>.endValue = endValue;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span>  <span class="keyword">long</span> <span class="title">incrementAndGet</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> ++currentValue;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/baidu/uid-generator/blob/master/README.zh_cn.md" target="_blank" rel="noopener">UidGenerator</a></li>
<li><a href="https://github.com/Meituan-Dianping/Leaf" target="_blank" rel="noopener">Leaf</a></li>
<li><a href="https://tech.meituan.com/2019/03/07/open-source-project-leaf.html" target="_blank" rel="noopener">Leaf：美团分布式ID生成服务开源</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ%3D%3D&amp;mid=2651960245&amp;idx=1&amp;sn=5cef3d8ca6a3e6e94f61e0edaf985d11&amp;chksm=bd2d06698a5a8f7fc89056af619b9b7e79b158bceb91bdeb776475bc686721e36fb925904a67&amp;mpshare=1&amp;scene=1&amp;srcid=0626i5Oy0egfPAKrFc5VFrAK" target="_blank" rel="noopener">分布式ID生成器</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.1" async></script><a data-url="https://jverson.com/2019/01/12/global-id-generator/" data-id="ck0ut0lii0000fsfy0y7n5af8" class="article-share-link">分享到</a><div class="tags"><a href="/tags/MySQL/">MySQL</a></div><div class="post-nav"><a href="/2019/02/20/behavior_parameterization/" class="pre">行为参数化 -  JDK8 Lambda 实现</a><a href="/2018/12/01/enum/" class="next">枚举类的高阶用法</a></div><div id="disqus_thread"><script>var disqus_shortname = 'jverson';
var disqus_identifier = '2019/01/12/global-id-generator/';
var disqus_title = '基于 MySQL 的分布式 ID 生成服务';
var disqus_url = 'https://jverson.com/2019/01/12/global-id-generator/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//jverson.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><a href="https://jverson.com/"><img src="https://wx4.sinaimg.cn/mw1024/74993f9ely1fuptmctad9j20cg0cg40p.jpg" alt border="0" style="margin-top:15px; border-radius: 300px;" width="180px" ; height="180px"></a></div><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://jverson.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-book"> 笔记</i></div><ul></ul><a href="https://jverson.com/ai/" title="AI" target="_blank">AI</a><ul></ul><a href="https://jverson.com/thinking-in-java/" title="Thinking in Java" target="_blank">Thinking in Java</a><ul></ul><a href="https://jverson.com/spring-boot-demo/" title="Spring Boot" target="_blank">Spring Boot</a></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Coding/">Coding</a><span class="category-list-count">29</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Thinking/">Thinking</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Travelling/">Travelling</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/GitHub/" style="font-size: 15px;">GitHub</a> <a href="/tags/Algorithm/" style="font-size: 15px;">Algorithm</a> <a href="/tags/Java8/" style="font-size: 15px;">Java8</a> <a href="/tags/Https/" style="font-size: 15px;">Https</a> <a href="/tags/Cache/" style="font-size: 15px;">Cache</a> <a href="/tags/Alfred-Markdown/" style="font-size: 15px;">Alfred Markdown</a> <a href="/tags/AutoHotkey/" style="font-size: 15px;">AutoHotkey</a> <a href="/tags/Concurrent/" style="font-size: 15px;">Concurrent</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/Frontend/" style="font-size: 15px;">Frontend</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/AI/" style="font-size: 15px;">AI</a> <a href="/tags/Summary/" style="font-size: 15px;">Summary</a> <a href="/tags/Memory/" style="font-size: 15px;">Memory</a> <a href="/tags/Tools/" style="font-size: 15px;">Tools</a> <a href="/tags/Hadoop/" style="font-size: 15px;">Hadoop</a> <a href="/tags/Travelling/" style="font-size: 15px;">Travelling</a> <a href="/tags/Cookie/" style="font-size: 15px;">Cookie</a> <a href="/tags/Session/" style="font-size: 15px;">Session</a> <a href="/tags/Http/" style="font-size: 15px;">Http</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-bar-chart"> 访客统计</i></div><a href="https://s05.flagcounter.com/more/quj"><img src="https://s05.flagcounter.com/count2/quj/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_10/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" alt="Since 2016.04.28" border="0" style="margin-top:15px;"></a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">墨言.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" href="https://jverson.com"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.1" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.1"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.1"></script></div></body></html>