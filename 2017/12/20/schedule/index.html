<!DOCTYPE html><html lang="zh-CN"><head><meta name="baidu-site-verification" content="WJEAqh4Drc" /><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="jverson's blog | java | web | Jverson"><title>Spring Boot 集成 Quartz 实现动态任务调度 | 墨言</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.1"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Spring Boot 集成 Quartz 实现动态任务调度</h1><a id="logo" href="/.">墨言</a><p class="description">LIFE IS SIMPLE, LOVE SMILE AND CODE</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="http://album.jverson.com/"><i class="fa fa-picture-o"> 相册</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Spring Boot 集成 Quartz 实现动态任务调度</h1><div class="post-meta">Dec 20, 2017<span> | </span><span class="category"><a href="/categories/Coding/">Coding</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/12/20/schedule/" href="/2017/12/20/schedule/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>最近使用 spring boot、 quartz、H2(内存数据库) 以及 RabbitMQ 等实现了一个动态的任务管理系统，可以动态的进行任务的创建、修改、暂停、运行以及删除操作，并且使用了 RabbitMQ 消息队列实现了定时任务系统与具体业务系统的解耦，再也不需要每次加个定时任务都上线一次了。<a id="more"></a></p>
<h2 id="Java-实现定时任务的几种方式对比"><a href="#Java-实现定时任务的几种方式对比" class="headerlink" title="Java 实现定时任务的几种方式对比"></a>Java 实现定时任务的几种方式对比</h2><p>目前 Java 系统中实现调度任务的方式大体有一下三种：</p>
<ul>
<li>使用 JDK 自带的 <code>java.util.Timer</code> 及 <code>java.util.TimerTask</code> 类实现</li>
<li>使用 Spring 定时任务</li>
<li>使用第三方插件 Quartz</li>
</ul>
<p>如果是在纯粹的 Java 环境需要实现定时任务毫无疑问就使用 JDK 自带的<code>java.util.concurrent.ScheduledExecutorService</code> 替代 <code>Timer &amp; TimerTask</code> 实现即可，这种场景一般比较简单，也不存在集群的问题。</p>
<p>如果是集成 Spring 框架开发应用，则使用 Spring 的 <code>@Scheduled</code> 注解实现，简洁方便省事。但是此类应用很可能是集群部署，因此需要通过一定的途径避免集群环境下任务被多次调用的现象发生。常见的方法有使用 Redis 存储一个会过期的常量锁，每台容器执行器先读取锁变量值判断任务是否已被执行；另一种常见的方法是只让指定IP的容器执行定时任务（存在单点的问题）。</p>
<p>如果在集群环境下，想实现定时任务的可视化管理，或者想做一个统一的定时任务应用，亦或者定时任务的场景非常复杂，则建议使用企业级应用系统常用的 Quartz，而且现在 Spring 或者 Springboot 集成Quartz 也非常方便。</p>
<h2 id="Spring-Boot-Quartz-任务调度系统预览"><a href="#Spring-Boot-Quartz-任务调度系统预览" class="headerlink" title="Spring Boot + Quartz 任务调度系统预览"></a>Spring Boot + Quartz 任务调度系统预览</h2><p>源码：<a href="https://github.com/jiwenxing/springboot-quartz" target="_blank" rel="external">https://github.com/jiwenxing/springboot-quartz</a></p>
<p>预览：<br><img src="http://ochyazsr6.bkt.clouddn.com/206751c9ac95c7860f087a02e5f2fd9f.jpg" alt=""></p>
<p>这里也将常规的 Quartz 与 Spring 的整合过程记录如下。</p>
<h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- Includes spring's support classes for quartz --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.quartz-scheduler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="创建-job"><a href="#创建-job" class="headerlink" title="创建 job"></a>创建 job</h3><p>创建一个 Job 类，该类需要继承 QuartzJobBean 或者实现 Job 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line">	<span class="meta">@Autowired</span></div><div class="line">	<span class="keyword">private</span> SampleService sampleService;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">    	<span class="comment">// execute task inner quartz system</span></div><div class="line">    	<span class="comment">// spring bean can be @Autowired</span></div><div class="line">    	sampleService.hello(jobName);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="配置-jobDetail、jobTrigger-及-schedule-实例"><a href="#配置-jobDetail、jobTrigger-及-schedule-实例" class="headerlink" title="配置 jobDetail、jobTrigger 及 schedule 实例"></a>配置 jobDetail、jobTrigger 及 schedule 实例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> JobDetailFactoryBean <span class="title">sampleJobDetail</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> createJobDetail(SampleJob.class);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Bean</span>(name = <span class="string">"sampleJobTrigger"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> SimpleTriggerFactoryBean <span class="title">sampleJobTrigger</span><span class="params">(@Qualifier(<span class="string">"sampleJobDetail"</span>)</span> JobDetail jobDetail,</span></div><div class="line">                                                 @<span class="title">Value</span><span class="params">(<span class="string">"$&#123;samplejob.frequency&#125;"</span>)</span> <span class="keyword">long</span> frequency) &#123;</div><div class="line">    <span class="keyword">return</span> createTrigger(jobDetail, frequency);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> Scheduler <span class="title">schedulerFactoryBean</span><span class="params">(DataSource dataSource, JobFactory jobFactory,</span></span></div><div class="line">                                      @Qualifier(<span class="string">"sampleJobTrigger"</span>) Trigger sampleJobTrigger) <span class="keyword">throws</span> Exception &#123;</div><div class="line">    SchedulerFactoryBean factory = <span class="keyword">new</span> SchedulerFactoryBean();</div><div class="line">    <span class="comment">// this allows to update triggers in DB when updating settings in config file:</span></div><div class="line">    factory.setOverwriteExistingJobs(<span class="keyword">true</span>);</div><div class="line">    factory.setDataSource(dataSource);</div><div class="line">    factory.setJobFactory(jobFactory);</div><div class="line"></div><div class="line">    factory.setQuartzProperties(quartzProperties());</div><div class="line">    factory.afterPropertiesSet();</div><div class="line"></div><div class="line">    Scheduler scheduler = factory.getScheduler();</div><div class="line">    scheduler.setJobFactory(jobFactory);</div><div class="line">    scheduler.scheduleJob((JobDetail) sampleJobTrigger.getJobDataMap().get(<span class="string">"jobDetail"</span>), sampleJobTrigger);</div><div class="line"></div><div class="line">    scheduler.start();</div><div class="line">    <span class="keyword">return</span> scheduler;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><h3 id="引入-spring-context-support-依赖（非必须）"><a href="#引入-spring-context-support-依赖（非必须）" class="headerlink" title="引入 spring-context-support 依赖（非必须）"></a>引入 spring-context-support 依赖（非必须）</h3><p>在使用 Spring 集成 Quartz 的时候，一定不要忘记引入 spring-context-support 这个包，该依赖包含支持UI模版（Velocity，FreeMarker，JasperReports），邮件服务，脚本服务(JRuby)，缓存Cache（EHCache），任务计划Scheduling（uartz）等方面的类。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="job-中无法注入业务类"><a href="#job-中无法注入业务类" class="headerlink" title="job 中无法注入业务类"></a>job 中无法注入业务类</h3><p>Job 类中，注入 XXService 的时候，会报空指针异常，因为 Job 对象是 Quartz 通过反射创建的，而业务 service 是通过 Spring 创建的，所以在 Job 类中使用由 Spring 管理的对象就会报空指针异常。</p>
<p>Quartz 中有一个 JobFactory 接口，负责生成 Job 类的实例。那我们是不是可以通过自定义实现这个接口在创建 Job 的时候给予依赖注入的特性，实现如下所示，最后在 SchedulerFactoryBean 中设置新的 JobFactory 即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringJobFactory</span> <span class="keyword">extends</span> <span class="title">SpringBeanJobFactory</span> <span class="keyword">implements</span></span></div><div class="line">        <span class="title">ApplicationContextAware</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> AutowireCapableBeanFactory beanFactory;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(<span class="keyword">final</span> ApplicationContext context)</span> </span>&#123;</div><div class="line">        beanFactory = context.getAutowireCapableBeanFactory();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">createJobInstance</span><span class="params">(<span class="keyword">final</span> TriggerFiredBundle bundle)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">final</span> Object job = <span class="keyword">super</span>.createJobInstance(bundle);</div><div class="line">        beanFactory.autowireBean(job);</div><div class="line">        <span class="keyword">return</span> job;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerConfig</span> </span>&#123;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> SpringJobFactory springJobFactory;</div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SchedulerFactoryBean <span class="title">schedulerFactoryBean</span><span class="params">()</span> </span>&#123;</div><div class="line">        SchedulerFactoryBean schedulerFactoryBean = <span class="keyword">new</span> SchedulerFactoryBean();</div><div class="line">        schedulerFactoryBean.setJobFactory(springJobFactory);</div><div class="line">        <span class="keyword">return</span> schedulerFactoryBean;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="REFERENCES"><a href="#REFERENCES" class="headerlink" title="REFERENCES"></a>REFERENCES</h2><ul>
<li><a href="https://github.com/davidkiss/spring-boot-quartz-demo" target="_blank" rel="external">https://github.com/davidkiss/spring-boot-quartz-demo</a></li>
<li><a href="http://lixuguang.iteye.com/blog/2256478" target="_blank" rel="external">quartz与spring实现任务动态管理</a></li>
<li><a href="https://www.dexcoder.com/selfly/article/308" target="_blank" rel="external">Spring 3整合Quartz 2实现定时任务</a></li>
<li><a href="https://blog.seveniu.com/post/spring-quartz-autowired/" target="_blank" rel="external">Spring 中使用 Quartz 时，Job 无法注入spring bean的问题</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.1" async></script><a data-url="http://jverson.com/2017/12/20/schedule/" data-id="cjhcvpyf2003rebfyezkvgt2p" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2017/11/25/Spring-Conditional/" class="pre">Spring @Conditional Annotation</a><a href="/2018/01/01/2018/" class="next">砥砺前行，不忘初心</a></div><div id="disqus_thread"><script>var disqus_shortname = 'jverson';
var disqus_identifier = '2017/12/20/schedule/';
var disqus_title = 'Spring Boot 集成 Quartz 实现动态任务调度';
var disqus_url = 'http://jverson.com/2017/12/20/schedule/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//jverson.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><a href="https://jverson.com/"><img src="http://ochyazsr6.bkt.clouddn.com/201610131152_383.jpg" alt="" border="0" style="margin-top:15px; border-radius: 300px;" width="180px"; height="180px"; ></a></div><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://jverson.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Coding/">Coding</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Thinking/">Thinking</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Travelling/">Travelling</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/GitHub/" style="font-size: 15px;">GitHub</a> <a href="/tags/Cache/" style="font-size: 15px;">Cache</a> <a href="/tags/Alfred-Markdown/" style="font-size: 15px;">Alfred Markdown</a> <a href="/tags/AutoHotkey/" style="font-size: 15px;">AutoHotkey</a> <a href="/tags/Concurrent/" style="font-size: 15px;">Concurrent</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Frontend/" style="font-size: 15px;">Frontend</a> <a href="/tags/Hadoop/" style="font-size: 15px;">Hadoop</a> <a href="/tags/Travelling/" style="font-size: 15px;">Travelling</a> <a href="/tags/Https/" style="font-size: 15px;">Https</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/Summary/" style="font-size: 15px;">Summary</a> <a href="/tags/Memory/" style="font-size: 15px;">Memory</a> <a href="/tags/Basic/" style="font-size: 15px;">Basic</a> <a href="/tags/Cookie/" style="font-size: 15px;">Cookie</a> <a href="/tags/Session/" style="font-size: 15px;">Session</a> <a href="/tags/Http/" style="font-size: 15px;">Http</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-bar-chart"> 访客统计</i></div><a href="https://s05.flagcounter.com/more/quj"><img src="https://s05.flagcounter.com/count2/quj/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_10/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" alt="Since 2016.04.28" border="0" style="margin-top:15px;"></a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">墨言.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" href="https://jverson.com"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.1" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.1"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.1"></script></div></body></html>